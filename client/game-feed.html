<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SnapGame Platform</title>
  <style>
    body {
      margin: 0;
      background-color: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .game-container {
      width: 400px;
      height: 600px;
      margin: 20px 0;
      background-color: #000;
      position: relative;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .swipe-zone {
      position: fixed;
      left: 0;
      width: 100vw;
      height: 80px;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
    }

    #swipe-top {
      top: 0;
    }

    #swipe-bottom {
      bottom: 0;
    }

    .arrow {
      font-size: 24px;
      color: white;
      opacity: 0.4;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <div id="coin-display">ü™ô Coins: 0</div>
  <style>
    #coin-display {
      position: fixed;
      top: 10px;
      right: 10px;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 9999;
      opacity: 0.9;
    }
  </style>

  <div id="feed"></div>
  <div id="swipe-top" class="swipe-zone">
    <div class="arrow">‚¨áÔ∏è</div>
  </div>
  <div id="swipe-bottom" class="swipe-zone">
    <div class="arrow">‚¨ÜÔ∏è</div>
  </div>

  <script src="games/shared/finish-ui.js"></script>
  <script src="games/list/game-list.js"></script>

  <script src="config.js"></script>

  <script>
    const gameOrder = Array.from({ length: gameList.length }, (_, i) => i);

    for (let i = gameOrder.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [gameOrder[i], gameOrder[j]] = [gameOrder[j], gameOrder[i]];
    }

    let currentIndex = 0;

    function loadNextGame() {
      currentIndex = (currentIndex + 1) % gameOrder.length;
      loadGame(currentIndex, 0); 
    }

    function loadPreviousGame() {
      currentIndex = (currentIndex - 1 + gameOrder.length) % gameOrder.length;
      loadGame(currentIndex, 0);
    }
  </script>
  <script>

    let currentGameIndex = 0;
    let currentLevelIndex = 0;

    const feed = document.getElementById("feed");

    function loadGame(gameIndex, levelIndex) {
      const game = gameList[gameIndex];
      const levelUrl = game.levels[levelIndex];

      const wrapper = document.createElement("div");
      wrapper.className = "game-container";

      const iframe = document.createElement("iframe");
      iframe.src = levelUrl;
      wrapper.appendChild(iframe);

      feed.innerHTML = "";
      feed.appendChild(wrapper);

      currentGameIndex = gameIndex;
      currentLevelIndex = levelIndex;
    }

    async function loadUserCoins() {
      try {
        const res = await fetch(`${SERVER_CONFIG.BASE_URL}/api/user/${window.USER_ID.BASE_ID}/coins`);
        const data = await res.json();
        const coins = data.coins ?? 0;

        document.getElementById("coin-display").textContent = `ü™ô Coins: ${coins}`;
      } catch (err) {
        console.error("Failed to load coins", err);
      }
    }

    window.addEventListener("message", async (event) => {
      const { type, score, currentLevel } = event.data;
      if (type === "finish") {
        alert("üéâ You scored " + score + " points!");

        await fetch(`${SERVER_CONFIG.BASE_URL}/api/game/result`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: window.USER_ID.BASE_ID,
            score: score,
            currentLevel: currentLevel
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log("ÏÑúÎ≤Ñ ÏùëÎãµ:", data);
        })
        .catch(err => {
          console.error("ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ïã§Ìå®:", err);
        });

        await loadUserCoins();
        loadNextGame();
      }

      if (type === "double") {
        const game = gameList[currentGameIndex];
        if (currentLevelIndex + 1 < game.levels.length) {
          loadGame(currentGameIndex, currentLevelIndex + 1);
        }
      }

      if (type === "clear") {
        alert("üéâ You cleared the final level!");
        alert("üéâ You scored " + score + " points!");

        await fetch(`${SERVER_CONFIG.BASE_URL}/api/game/result`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: window.USER_ID.BASE_ID,
            score: score,
            currentLevel: currentLevel
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log("ÏÑúÎ≤Ñ ÏùëÎãµ:", data);
        })
        .catch(err => {
          console.error("ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ïã§Ìå®:", err);
        });

        await loadUserCoins();
        loadNextGame();
      }
    });

    loadGame(currentGameIndex, 0);
    (async () => { await loadUserCoins(); })();	
  </script>

  <script>
    let touchStartY = 0;
    let touchEndY = 0;

    ["swipe-top", "swipe-bottom"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("touchstart", (e) => {
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      el.addEventListener("touchend", (e) => {
        touchEndY = e.changedTouches[0].screenY;
        handleSwipeGesture();
      }, { passive: true });
    });

    function handleSwipeGesture() {
      if (touchStartY - touchEndY > 100) {
        loadNextGame();
      }
      else {
        loadPreviousGame();
      }
    }
  </script>
</body>
</html>
